# 1、Development environment construction

## 一、Project Profile

Address of this project :  [https://github.com/Mikaelemmmm/go-zero-looklook](https://github.com/Mikaelemmmm/go-zero-looklook)

The whole project uses go-zero developed microservices, which basically includes go-zero and some middleware developed by related go-zero authors, and the technology stack used is basically the self-developed components of go-zero project team, which is basically go-zero family bucket.

The development environment of this project recommends docker-compose, using the direct chain method, giving up the trouble brought by service registration discovery middleware (etcd, nacos, consul, etc.)

Testing, online deployment using k8s (also do not need etc.) have a detailed tutorial (build + deployment), you can enter the go-zero community group communication, very easy

The project directory structure is as follows：

- admin：Background code (integrated gin-vue-admin, acting as a large gateway to the background), the use of grpc and app under the rpc business interaction, background gin-vue-admin and go-zero code interaction in the banner function has an example to view, if you do not want the background, directly delete the entire folder admin, in the execution of a go mod tidy can
- admin/web :  Backend web-side code, gin-vue-admin

- app：All business code contains api, rpc and mq (message queue, delay queue, timed tasks)

- common：Generic components error, middleware, interceptor, tool, ctxdata, etc.

- data：This project contains data generated by all the middleware (mysql, es, redis, grafana, etc.) that this directory depends on. Everything in this directory should be in the git ignore file and does not need to be committed.

- deploy：

  - filebeat: docker deployment filebeat configuration
  - go-stash：go-stash configuration
  - nginx: nginx gateway
  - prometheus ： prometheus configuration
  - script：
        - gencode：Generate api, rpc, and create kafka statements, copy and paste to use
        - mysql：Generate sh tools for mods
    - goctl: The project goctl template, goctl generate custom code template, tempalte usage can refer to go-zero documentation, copy to the home directory .goctl can
- doc : The project series documentation

- modd.conf :  modd hot-loading configuration file, do not be afraid ~ it is very simple to use, about modd more usage can go here to understand: https://github.com/cortesi/modd, the project mirror will only golang-1.17.7-alpine as the base image installed modd in the internal, if you want to put goctl, protoc, golint, etc. protoc, golint, etc., do not use my mirror directly to create a mirror is also the same ha

    Translated with www.DeepL.com/Translator (free version)

## 二、Use to technology stack

- k8s

- go-zero

- nginx网关

- filebeat

- kafka

- go-stash

- elasticsearch

- kibana

- prometheus

- grafana

- jaeger

- go-queue

- asynq

- asynqmon

- dtm

- docker

- docker-compose

- mysql

- redis

- gin-vue-admin

- air

- modd

- jenkins

- gitlab

- harbor

## 三、Project Architecture Diagram

![gozerolooklook](../chinese/images/1/gozerolooklook.png)

## 四、Business Architecture Diagram

![gozerolooklook](../chinese/images/1/go-zero-looklook-service.png)

## 五、Project Environment Setup

### ⚠️If you encounter problems during the build process, you can see "九. Common Errors"

The project uses modd hot-loading function instantly modify the code in time to take effect, and do not need to restart each time, change the code automatically in the container reload, local services do not need to start, locally installed sdk is to write code automatically prompted to use, the actual run is since the container lyumikael/go-modd-env:v1.0.0 golang environment. So use goland, vscode are the same

Translated with www.DeepL.com/Translator (free version)

[Note] Since this project has more middleware, starting docker on non-linux may consume more memory, so it is recommended that the memory allocated to docker on the physical machine be adjusted to 8G.

### 1、clone code & update dependencies

```shell
$ git clone https://github.com/Mikaelemmmm/go-zero-looklook
$
$ go mod tidy
```

### 2、The environment on which the project is launched

```shell
$ docker-compose -f docker-compose-env.yml up -d
```

### 3、Importing Data

#### 3.1 Creating a kafka topic

The system uses 3 topics, the default is not to allow the program to automatically create a topic, into the kafka container to create 3 topics

Enter the container

```shell
$ docker exec -it kafka /bin/sh
$ cd /opt/kafka/bin/
```

Create 3 topics

```shell
$ ./kafka-topics.sh --create --zookeeper zookeeper:2181 --replication-factor 1 -partitions 1 --topic looklook-log
$
$ ./kafka-topics.sh --create --zookeeper zookeeper:2181 --replication-factor 1 -partitions 1 --topic payment-update-paystatus-topic
$
$ ./kafka-topics.sh --create --zookeeper zookeeper:2181 --replication-factor 1 -partitions 1 --topic send-wx-mini-tpl-message
$
```

looklook-log ： The log collection uses the

payment-update-paystatus-topic ： Payment success notification

send-wx-mini-tpl-message：Send WeChat applet notifications

#### 3.2 Importing mysql data

For local tools to connect to mysql, you need to enter the container first and set remote connection privileges for root

[note!]

**The database must be created first!!!, Otherwise, an error will be reported later**

There are mainly four databases: looklook_order、looklook_payment、looklook_travel、looklook_usercenter, and then import the corresponding SQL execution scripts respectively.

```shell
$ docker cp sql/ mysql:/tmp/
$ docker exec -it mysql mysql -uroot -p
## input Password：PXDN93VRKUm8TeE7
$ use mysql;
$ update user set host='%' where user='root';
$ FLUSH PRIVILEGES;
## create database 
$ create database looklook_order;
$ create database looklook_payment;
$ create database looklook_travel;
$ create database looklook_usercenter;
## import SQL data
$ use looklook_order;
$ source /tmp/sql/looklook_order.sql;
$
$ use looklook_payment;
$ source /tmp/sql/looklook_payment.sql;
$
$ use looklook_travel;
$ source /tmp/sql/looklook_travel.sql;
$
$ use looklook_usercenter;
$ source /tmp/sql/looklook_usercenter.sql;
```

### 4、View Service Environment

Elastic search: [http://127.0.0.1:9200/](http://127.0.0.1:9200/) （⚠️：This startup time is a bit long）

jaeger: [http://127.0.0.1:16686/search](http://127.0.0.1:16686/search)  (⚠️：If it fails, rely on es, because es start time is long this may timeout, wait for es start play restart a)

go-stash :  look log  (⚠️：If you are mac m1 or linux arm, please change the go-stash image in docker-compose-env.yml kevinwan/go-stash:1.0-arm64, the default is for linux amd)

asynq （Time-delayed, timed message queues）: [http://127.0.0.1:8980/](http://127.0.0.1:8980/)

kibana  : [http://127.0.0.1:5601/](http://127.0.0.1:5601/)

Prometheus: [http://127.0.0.1:9090/](http://127.0.0.1:9090/)

Grafana: [http://127.0.0.1:3001/](http://127.0.0.1:3001/)  ， The default account and password are admin

Mysql :   Self-client tools (Navicat, Sequel Pro) to view

- host : 127.0.0.1

- port : 33069  

- username : root

- pwd : PXDN93VRKUm8TeE7

Redis :   View by tool (redisManager)

- host : 127.0.0.1

- port : 36379

- pwd : G62m50oigInC30sf

Kafka:  Self-client tool view

- host : 127.0.0.1

- port : 9092

### 5、Start Service

#### 5.1 Pull the runtime environment image

Because this project is using docker + hot-loading, that is, the change is effective 

All api + rpc services under frontend app use modd + golang

The backend admin-api uses cosmtrek/air:v1.28.0

Direct docker-compose to start can, but consider the dependencies may be relatively large, will affect the start of the project, so it is best to pull down this image before starting the project

```shell
$ docker pull lyumikael/gomodd:v1.0.0 #This is used by all api+rpc startup services under the app, if you are "mac m1" : lyumikael/go-modd-env:v1.0.0
$ docker pull cosmtrek/air:v1.28.0 #This is the backend admin-api use , if you do not need the backend (note that docker-compose.yaml in the admin-api comments) this can not be used
```

Note: If you add new services under the app, remember to add a copy of modd.conf in the root directory of the project.

About modd more usage can go here to learn: [https://github.com/cortesi/modd](https://github.com/cortesi/modd), the project image is only golang-1.17.7-alpine as the base image installed modd in the internal.

If you want to add goctl, protoc, golint, etc., do not use my image directly to create a mirror is the same ha

#### 5.2 Start Project

```shell
$ docker-compose up -d 
```

[Note] The dependency is on the docker-compose.yml configuration in the project root directory

### 6、View project operation

Visit http://127.0.0.1:9090/, click on the menu above "Status", click on Targets, the blue one is started, the red one is not started successfully

![image-20220120103641110](../chinese/images/1/image-20220120103641110.png)

Note] If it is the first time to pull the project, each project container for the first time to build pull dependencies, this depends on the network situation, may be slightly slower to have the service, this is normal, if you encounter the project does not start up, such as order-api , manually in order-api code to write something randomly to save a trigger to recompile to see the log on it

```shell
$ docker-compose logs -f 
```

You can see that the prometheus also shows success, and similarly the other also row once, start successfully on it

<img src="../chinese/images/1/image-20220120105313819.png" alt="image-20220120105313819" style="zoom:33%;" />

### 7、Access Program

Since we use nginx as the gateway, the nginx gateway is configured in docker-compose, which is also configured in docker-compose, nignx exposes port 8888 to the public, so we access through port 8888

```shell
$ curl  -X POST "http://127.0.0.1:8888/usercenter/v1/user/register" -H "Content-Type: application/json" -d "{\"mobile\":\"18888888888\",\"password\":\"123456\"}" 

response:
{"code":200,"msg":"OK","data":{"accessToken":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NzM5NjY0MjUsImlhdCI6MTY0MjQzMDQyNSwiand0VXNlcklkIjo1fQ.E5-yMF0OvNpBcfr0WyDxuTq1SRWGC3yZb9_Xpxtzlyw","accessExpire":1673966425,"refreshAfter":1658198425}}
```

Note] If the access to nginx fails and the access success can be ignored, it may be that nginx depends on the back-end services, before the back-end services did not start up, nginx did not start up here, restart once nginx can, the project root directory restart

```shell
$ docker-compose restart nginx
```

## 六、Log Collection

Collect project logs to es (filebeat collects logs -> kafka -> go-stash consumes kafka logs -> output to es, kibana views es data)

Visit kibana [http://127.0.0.1:5601/](http://127.0.0.1:5601/) and create log index

Click on the top left menu (the three horizontal lines), find Analytics - > click on discover 

<img src="../chinese/images/1/image-20220120105829870.png" alt="image-20220120105829870" style="zoom:33%;" />

Then on the current page, Create index pattern->type looklook-* -> Next Step -> select @timestamp->Create index pattern

Then click the top left menu, find Analytics->click discover, the logs are displayed (if not, check filebeat, go-stash, use docker logs -f filebeat to view)

![image-20220120105947733](../chinese/images/1/image-20220120105947733.png)

⚠️Common reasons for collection failure

- The go-stash image is being used incorrectly  

    Look at the go-stash log, if there is a core dumped, it means that the mirror is being used incorrectly.

    Solution:

    If you are mac m1 or linux arm, please change the go-stash image in docker-compose-env.yml kevinwan/go-stash:1.0-arm64, the default is for linux amd.

- docker version problem

  Answer:

    This I did not actually encounter, but some students using docker version is 1.13 encountered, filebeat configuration file configuration to collect docker path low version docker may not be the same location resulting in the collection of docker internal logs, it is best to upgrade the docker18.03.1 above the current no problem, 17 did not actually test , 17 My side of the docker version is Version: 20.10.8

-  Internal kafka problem

  Solution:

    1) docker logs check the container logs of kafka, filbeat, go-stash, es in order to make sure the services are OK

    2) first docker logs -f filebeat to see if the filebeat is correctly connected to kafka

    3) Go into the kafka container and execute consume kafka-log messages to see if the filebeat messages have been sent to kafka

  ```shell
  $ docker exec -it kafka /bin/sh
  $ cd /opt/kafka/bin
  $ ./kafka-console-consumer.sh --bootstrap-server kafka:9092 --topic looklook-log 
  ```

  Note] If you can consume the messages, it means that filebeat and kafka are fine, so go check go-stash, es

  If you can not consume

  1) it should be a connection problem between filebeat and kafka, to see if the kafka configuration information Listen is modified

  2) In the kafka container internal command line using consumer.sh consumption looklook-log, another terminal command line with producer.sh to looklook-log send messages, if the consumer can not receive, indicating that the kafka problem, docker logs -f kafka to see what the problem

## 七、Introduction of this project mirror

- nginx : gateway （nginx->api->rpc）
- cosmtrek/air、modd : Our business code development depends on the environment image, the reason why we use this is because air hot-loading, writing code compiled in real time is too convenient, this image is air + golang, in fact, after we start our own business services, our business services are running in this image
- wurstmeister/kafka ： kafka
- wurstmeister/zookeeper ：kafka dependencies on zookeeper
- redis：Business use of redis
- mysql:Databases used by the business
- prom/prometheus：Monitoring Business
- grafana/grafana ：The prometheus ui is hard to read and is used to display the data collected by prometheus
- elastic/filebeat ： Collecting logs to kafka
- go-stash : Consume logs in kafka, desensitize, filter and export to es
- docker.elastic.co/elasticsearch/elasticsearch ： Storage of collected logs
- docker.elastic.co/kibana/kibana ：Show elasticsearch
- jaegertracing/all-in-one：Link Tracking
- go-stash : After filebeat collects the logs to kafka, go-stash goes to consume kafka to desensitize the data, filter the content in the logs, and finally output to es

## 八、Project Development Proposal

- app： decentralizes all business service codes

- common： Put up a public base library of all services

- data：The data project depends on the data generated by the middleware, so in practice you should ignore this directory and the data generated in this directory in git

- Generate api, rpc code：

Usually when we generate api, rpc code manually to knock goctl command is rather long and can not remember, so we go directly to deploy/script/gencode/gen.sh to copy the code. For example, I added a new service in usercenter service, change the password, after writing the api file, go to usercenter/cmd/api/desc directory, copy the generate api command in deploy/script/gencode/gen.sh to run it

```shell
$ goctl api go -api *.api -dir ../  -style=goZero
```

After writing the proto file, just copy the generate rpc command from deploy/script/gencode/gen.sh and run it

goctl >= 1.3 Go to the "services/cmd/rpc/pb" directory and execute the following command

```shell
$ goctl rpc protoc *.proto --go_out=../ --go-grpc_out=../  --zrpc_out=../
$ sed -i "" 's/,omitempty//g' *.pb.go
```

goctl < 1.3 Enter the "service/cmd" directory and execute the following command

```shell
$  goctl rpc proto -src rpc/pb/*.proto -dir ./rpc -style=goZero
$  sed -i "" 's/,omitempty//g'  ./rpc/pb/*.pb.go
```

Note] It is recommended that when generating the rpc file, execute the following command once more to remove the omitempty generated by protobuf, otherwise the field will not be returned if it is nil

- Generate kafka code：

  Because the project uses go-queue kq to do the message queue, kq and depend on the kafka, the actual is the use of kafka to do the message queue, but kq default is required in advance we build the topic, not allowed to automatically generate the default, so the command is also ready, directly copy the deploy/script/gencode/gen.sh to create the kafka topic code

  ```shell
   kafka-topics.sh --create --zookeeper zookeeper:2181 --replication-factor 1 -partitions 1 --topic {topic}
  ```

- To generate the model code, run deploy/script/mysql/genModel.sh directly with the parameters

- api project in the .api file we did a split, unified into the desc folder of each api, because if all the content is written in the api may not be easy to view, so do a split, write all the methods to an api, other entities and req, rep unified into a folder defined separately is clearer

- Generate mod, error handling when using the template redefinition, the project used a custom goctl template in the project deploy/goctl under

## 九、Common mistakes in building environments

```dock
1、Create stage, start docker-compose-env.yml container
Grafana reports an error You may have issues with file permissions, more information here: http://docs.grafana.org/installation/docker/#migrate-to-v51-or- later
mkdir: can't create directory '/var/lib/grafana/plugins': Permission denied
Permission denied: Permission denied. Add user: root to grafana in docker-compose-env.yml.

2, filebeat container startup error Exiting: error loading config file: config file ("filebeat.yml") must be owned by the user identifier (uid=0) or root
Due to different file owners (I clone the project under normal user), the config file of filebeat must be owned by root, you need to modify sudo chown root deploy/filebeat/conf/filebeat.yml 

3、elasticsearch container startup error ElasticsearchException[failed to bind service]; nested: AccessDeniedException[/usr/share/elasticsearch/data/nodes] ;
Likely root cause: java.nio.file.AccessDeniedException: /usr/share/elasticsearch/data/nodes
The reason for the error is that es does not have permission to operate the mount directory and cannot bind the nodes, solution, modify the permissions sudo chmod 777 data/elasticsearch/data (I don't know which user started es, so I changed 777 hard)

4, jaeger depends on elasticsearch and does not fail to restart automatically
```

## 十、Backend Launch

Considering that in the development if you re-write a background to do rbac and so on is still relatively troublesome, directly gin-vue-admin low code platform integration in directly with it, but the architecture is to consider the above, the

We put the whole background gin-vue-admin api interface as a whole big gateway can be used, which does not write any business-related operations, all business through the grpc to go with the app under the business of the rpc to data, the foreground according to the business split different api, the background only need a large api on it.

Q: Why not separate the back office to make a separate system?

A: Because in the project we use the db layer cache, the cache key is defined in the model, if a separate system of this cache key we have to copy a separate copy of the past, during which there may be problems such as omissions, so directly use the grpc to call on it.

### 1、start project

Create database looklook_admin and import deploy/sql/looklook_admin.sql data

```shell
$ docker-compose -f docker-compose-admin.yml up -d
$
$ docker exec -it mysql mysql -uroot -p
##input Password：PXDN93VRKUm8TeE7
$ create database looklook_admin;
$ use database looklook_admin;
$ source /tmp/sql/looklook_admin.sql

```

You can view the logs

```sh
$ docker logs -f admin-api
```

If the following problem occurs when viewing the backend logs.

2022/03/10 17:20:46 rpc dial: direct:///looklook:8008, error: context deadline exceeded, make sure rpc service "looklook:8008" is already started

This is because admin-api started first, it depends on the back end of the banner due to the slow download since a little did not start up, then wait for looklook in the banner to start up, restart the admin-api will be good

```sh
$ docker-compose restart admin-api
```

Now we just need to start the back-end front-end web, go to admin/web and execute the following command

```shell
$ npm install 
$ npm run serve
```

http://localhost:7082/#/init will be opened by default

Note】Do not click "Go to initialization", otherwise the configuration file will be overwritten

account：admin

password：123456

The whole project is gin-vue-admin, if you do not know directly to see the official gin-vue-admin can, they also have a video tutorial

just in the gin-vue-admin added a how to interact with go-zero call, login to enter the background, click on the menu at the bottom of the advertising management, this function can be seen in the admin-api call app/banner-rpc example, will not be detailed

## 十一、Follow-up

Due to the project as it relates to the technology stack is slightly more, will gradually add a little bit by chapter
